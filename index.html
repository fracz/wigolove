<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WigoLove</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="style.css"/>
    <script type="text/javascript" src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
            integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
</head>
<body>
<section id="app" class="section">
    <div class="container">
        <h1 class="title">WigoLove</h1>
        <p class="subtitle">Create <em>I ❤️ place</em> Wherigo Scenarios easily.</p>

        <div class="field">
            <label class="label">Name</label>
            <div class="control">
                <input class="input" type="text" v-model="wigo.name">
            </div>
            <p class="help">Try not to use diacritic characters here.</p>
        </div>

        <div class="field">
            <label class="label">Description</label>
            <div class="control">
                <textarea class="textarea" v-model="wigo.description"></textarea>
            </div>
            <p class="help">
                It will be used as the scenario description and it will be displayed as the first message for
                the user. Welcome user in the place and tell him what is the aim of this game.
            </p>
        </div>

        <div class="field">
            <label class="label">The number of points required to finish the game</label>
            <div class="control">
                <input class="input" type="number" v-model="wigo.requiredPoints" min="1" max="1000">
            </div>
        </div>

        <a @click="showMap()">Show map of all zones</a>

        <div v-for="zone in wigo.zones" :key="zone.id" class="my-3">
            <div class="field">
                <label class="label">Name</label>
                <div class="control">
                    <input class="input" type="text" v-model="zone.name">
                </div>
                <p class="help">Try not to use diacritic characters here.</p>
            </div>

            <div class="field">
                <label class="label">Description</label>
                <div class="control">
                    <textarea class="textarea" v-model="zone.description"></textarea>
                </div>
            </div>

            <div class="field">
                <label class="label">Area</label>
                <a @click="editZoneArea(zone)">{{ zone.area }}</a>
            </div>
        </div>

        <button class="button button-primary" @click="addZone()">Add new zone</button>
    </div>

    <div :class="['modal map-modal', {'is-active': mapModalOpened}]">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div id="map"></div>
            <div class="mt-3 has-text-right">
                <button type="button" class="button is-primary" @click="saveEditedZoneArea()">OK</button>
            </div>
        </div>
        <button class="modal-close is-large" aria-label="close" @click="mapModalOpened = false"></button>
    </div>
</section>

<script>
    const {createApp} = Vue
    let map;
    let editableLayers;
    let drawControl;
    let drawEditControl;

    createApp({
        data() {
            return {
                mapModalOpened: false,
                editingZone: undefined,
                currentPolygonCoords: [],
                wigo: {
                    name: 'I love Krakow',
                    description: '',
                    requiredPoints: 15,
                    zones: [],
                }
            }
        },
        mounted() {
        },
        methods: {
            addZone() {
                this.wigo.zones.push({
                    id: crypto.randomUUID(),
                    name: '',
                    description: '',
                    photo: '',
                    points: 1,
                    area: []
                });
            },
            editZoneArea(zone) {
                this.editingZone = zone;
                this.currentPolygonCoords = zone.area;
                this.showMap().then(() => {
                    console.log('added');
                    if (zone.area.length) {
                        // const geoJson = {
                        //     type: "Feature",
                        //     properties: {},
                        //     geometry: {type: "Polygon", coordinates: [zone.area]}
                        // };
                        // L.geoJSON(geoJson).addTo(editableLayers);
                        const polygon = L.polygon(zone.area);
                        // console.log(zone.area);
                        // const polygon = L.polygon([
                        //     [51.512642, -0.099993],
                        //     [51.520387, -0.087633],
                        //     [51.509116, -0.082483]
                        // ]);
                        // polygon.addTo(editableLayers);
                        editableLayers.addLayer(polygon);
                        // map.fitBounds(polygon.getBounds());
                        map.addControl(drawEditControl);
                    } else {
                        map.addControl(drawControl);
                    }
                });
            },
            saveEditedZoneArea() {
                this.editingZone.area = this.currentPolygonCoords;
                this.currentPolygonCoords = undefined;
                this.editingZone = undefined;
                this.mapModalOpened = false;
                map.removeControl(drawControl);
                map.removeControl(drawEditControl);
                editableLayers.clearLayers();
            },
            showMap() {
                this.mapModalOpened = true;
                return new Promise((resolve) => {
                    if (!map) {
                        this.$nextTick(() => {
                            this.initMap();
                            console.log('inited');
                            resolve();
                        });
                    } else {
                        resolve();
                    }
                });
            },
            initMap() {
                map = L.map('map', {doubleClickZoom: false}).setView([50, 19], 6);

                L.tileLayer(
                    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Data © <a href="http://osm.org/copyright">OpenStreetMap</a>',
                        maxZoom: 18
                    }).addTo(map);

                editableLayers = new L.FeatureGroup();
                map.addLayer(editableLayers);

                drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polygon: {
                            allowIntersection: false, // Restricts shapes to simple polygons
                            drawError: {
                                color: '#e1e100', // Color the shape will turn when intersects
                                message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                            },
                            shapeOptions: {
                                color: '#97009c'
                            }
                        },
                        // disable toolbar item by setting it to false
                        polyline: false,
                        circle: false, // Turns off this drawing tool
                        rectangle: false,
                        marker: false,
                    },
                    edit: false,
                });

                drawEditControl = new L.Control.Draw({
                    position: 'topright',
                    draw: false,
                    edit: {
                        featureGroup: editableLayers, //REQUIRED!!
                        remove: true
                    }
                });

                map.on('draw:created', (e) => {
                    const type = e.layerType;
                    const layer = e.layer;
                    console.log(layer._latlngs);
                    this.currentPolygonCoords = layer._latlngs;
                    // this.currentPolygonCoords = layer.toGeoJSON().geometry.coordinates[0];

                    if (type === 'marker') {
                        layer.bindPopup('A popup!');
                    }
                    map.removeControl(drawControl);
                    map.addControl(drawEditControl);
                    editableLayers.addLayer(layer);
                });

                map.on('draw:deletestop', (e) => {
                    editableLayers.clearLayers();
                    map.removeControl(drawEditControl);
                    map.addControl(drawControl);
                });

            },
        }
    }).mount('#app');
</script>
</body>
</html>
